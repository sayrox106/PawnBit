name: Build & Release

# Triggers on any tag like v1.0.0-beta.1, v0.9.0, etc.
# Also allows manual dispatch from the Actions UI.
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to use (e.g. v1.0.0-beta.1)"
        required: true
        default: "v1.0.0-beta.1"

permissions:
  contents: write # needed to create/upload releases

# ---------------------------------------------------------------------------
jobs:
  # ---------------------------------------------------------------------------

  # â”€â”€ Build on each platform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build  [${{ matrix.os }}]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # let all platforms finish even if one fails
      matrix:
        include:
          - os: windows-latest
            artifact: PawnBit-windows.exe
            dist_name: PawnBit.exe

          - os: macos-latest
            artifact: PawnBit-macos
            dist_name: PawnBit

          - os: ubuntu-latest
            artifact: PawnBit-linux
            dist_name: PawnBit

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout source
        uses: actions/checkout@v4

      # â”€â”€ 2. Python setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # â”€â”€ 3. Platform-specific system dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            python3-tk \
            python3-dev \
            libxcb-xinerama0 \
            libxkbcommon-x11-0 \
            xvfb \
            scrot \
            libgirepository1.0-dev

      - name: Install system deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install python-tk@3.11 || true

      # â”€â”€ 4. Python dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pyinstaller>=6.0
          pip install -r requirements.txt

      # â”€â”€ 5. Build executable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: pyinstaller --clean PawnBit.spec

      - name: Build with PyInstaller (macOS / Linux)
        if: runner.os != 'Windows'
        run: pyinstaller --clean PawnBit.spec

      # â”€â”€ 6. Rename output to platform-specific artifact name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Rename artifact
        shell: bash
        run: mv "dist/${{ matrix.dist_name }}" "dist/${{ matrix.artifact }}"

      # â”€â”€ 7. Upload artifact to be consumed by the release job â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/${{ matrix.artifact }}
          if-no-files-found: error

  # â”€â”€ Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Download all platform artifacts into one folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      # â”€â”€ 2. Determine the tag / version string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ 3. Publish pre-release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PawnBit ${{ steps.version.outputs.tag }} (Beta)"
          prerelease: true
          draft: false
          body: |
            ## ðŸŽ® PawnBit ${{ steps.version.outputs.tag }} â€” Beta

            > âš ï¸ **This is a pre-release / beta build.** Expect rough edges.
            > Please report issues here: [GitHub Issues](../../issues)

            ---

            ### ðŸ“¥ Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | ðŸªŸ **Windows** | `PawnBit-windows.exe` | Double-click to run |
            | ðŸŽ **macOS** | `PawnBit-macos` | See instructions below |
            | ðŸ§ **Linux** | `PawnBit-linux` | See instructions below |
            | ðŸ“¦ **Source** | `Source code (zip / tar.gz)` | Run via `run.bat` or `python src/gui.py` |

            ---

            ### ðŸš€ Getting started

            **Windows**
            1. Download `PawnBit-windows.exe`
            2. Run it â€” Stockfish is downloaded automatically on first launch

            **macOS / Linux**
            ```bash
            chmod +x PawnBit-macos   # or PawnBit-linux
            ./PawnBit-macos
            ```
            > macOS may prompt for Accessibility permissions (needed for pyautogui).

            **Source code**
            ```bash
            python -m venv venv
            # Windows:
            venv\Scripts\pip install -r requirements.txt
            venv\Scripts\python src\gui.py
            # macOS / Linux:
            venv/bin/pip3 install -r requirements.txt
            venv/bin/python3 src/gui.py
            ```

            ---

            ### âœ¨ What's new in v1.0.0-beta.1.3
            - **Lightweight Architecture**: Replaced heavy PyQt6 with vanilla Tkinter and swapped Multiprocessing for Threading.
            - **Lighter Build**: EXE size reduced by ~40MB (Stockfish is now auto-downloaded on first run instead of bundled).
            - **Better Stability**: Threaded browser launching and robust error logging (no more "Not Responding" during startup).
            - **AV Compatibility**: Disabled UPX and implemented proper symbol stripping to reduce Antivirus false positives.
            - **Smart Analytics**: Real-time evaluation bar, W/D/L stats, and accuracy estimation.
            - **Engine Management**: Full support for Stockfish 18 with automatic installation and updates.

          files: |
            release-assets/PawnBit-windows.exe
            release-assets/PawnBit-macos
            release-assets/PawnBit-linux
