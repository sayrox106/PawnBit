name: Build & Release

# Triggers on any tag like v1.0.0-beta.1, v0.9.0, etc.
# Also allows manual dispatch from the Actions UI.
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to use (e.g. v1.0.0-beta.1)"
        required: true
        default: "v1.0.0-beta.3"

permissions:
  contents: write # needed to create/upload releases

# ---------------------------------------------------------------------------
jobs:
  # ---------------------------------------------------------------------------

  # â”€â”€ Build on each platform â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build  [${{ matrix.os }}]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false # let all platforms finish even if one fails
      matrix:
        include:
          - os: windows-latest
            artifact: PawnBit-windows.exe
            dist_name: PawnBit.exe

          - os: macos-latest
            artifact: PawnBit-macos
            dist_name: PawnBit

          - os: ubuntu-latest
            artifact: PawnBit-linux
            dist_name: PawnBit

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout source
        uses: actions/checkout@v4

      # â”€â”€ 2. Python setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # â”€â”€ 3. Platform-specific system dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            python3-tk \
            python3-dev \
            libxcb-xinerama0 \
            libxkbcommon-x11-0 \
            xvfb \
            scrot \
            libgirepository1.0-dev

      - name: Install system deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install python-tk@3.11 || true

      # â”€â”€ 4. Python dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pyinstaller>=6.0
          pip install -r requirements.txt

      # â”€â”€ 5. Build executable â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Prepare bundled engine (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "src/assets/engines/default"
          $TAG = "sf_18"
          $variants = @(
            "stockfish-windows-x86-64-avx2.zip",
            "stockfish-windows-x86-64-bmi2.zip",
            "stockfish-windows-x86-64-sse41-popcnt.zip",
            "stockfish-windows-x86-64-modern.zip"
          )

          $success = $false
          foreach ($v in $variants) {
            $url = "https://github.com/official-stockfish/Stockfish/releases/download/$TAG/$v"
            Write-Host "Trying to download bundled engine: $url ..."
            try {
              Invoke-WebRequest -Uri $url -OutFile "sf.zip" -ErrorAction Stop
              $success = $true
              Write-Host "Successfully downloaded $v"
              break
            } catch {
              Write-Host "Failed to download $v (404 or network error)."
            }
          }

          if (-not $success) {
            Write-Error "Could not download any Stockfish variant for Windows!"
            exit 1
          }

          Expand-Archive -Path "sf.zip" -DestinationPath "temp_sf"
          $bin = Get-ChildItem -Path "temp_sf" -Filter "stockfish*.exe" -Recurse | Select-Object -First 1
          Move-Item -Path $bin.FullName -Destination "src/assets/engines/default/stockfish.exe"
          '{"version":"18","build":"bundled","arch":"x86-64","binary_path":"assets/engines/default/stockfish.exe"}' | Out-File -FilePath "src/assets/engines/default/version.json" -Encoding utf8

      - name: Build with PyInstaller (Windows)
        if: runner.os == 'Windows'
        run: pyinstaller --clean PawnBit.spec

      - name: Prepare bundled engine (macOS / Linux)
        if: runner.os != 'Windows'
        run: |
          mkdir -p src/assets/engines/default
          TAG="sf_18"
          if [ "${{ runner.os }}" = "macOS" ]; then
            VARIANTS=("stockfish-macos-arm64-apple-silicon.tar" "stockfish-macos-x86-64-avx2.tar" "stockfish-macos-x86-64.tar")
          else
            VARIANTS=("stockfish-ubuntu-x86-64-avx2.tar" "stockfish-ubuntu-x86-64-sse41-popcnt.tar" "stockfish-linux-x86-64-avx2.tar")
          fi

          SUCCESS=0
          for v in "${VARIANTS[@]}"; do
            URL="https://github.com/official-stockfish/Stockfish/releases/download/$TAG/$v"
            echo "Trying to download bundled engine: $URL ..."
            if curl -L -f -o sf.tar "$URL"; then
              echo "Successfully downloaded $v"
              SUCCESS=1
              break
            fi
          done

          if [ $SUCCESS -eq 0 ]; then
            echo "Error: Could not download any Stockfish variant for ${{ runner.os }}!"
            exit 1
          fi

          tar -xf sf.tar
          BIN=$(find . -maxdepth 4 -name "stockfish*" -type f ! -name "*.tar" ! -name "*.zip" | head -n 1)
          cp "$BIN" src/assets/engines/default/stockfish
          chmod +x src/assets/engines/default/stockfish
          echo '{"version":"18","build":"bundled","arch":"native","binary_path":"assets/engines/default/stockfish"}' > src/assets/engines/default/version.json

      - name: Build with PyInstaller (macOS / Linux)
        if: runner.os != 'Windows'
        run: pyinstaller --clean PawnBit.spec

      # â”€â”€ 6. Create ZIP variant (High Stability) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create Portable ZIP
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/PawnBit.exe" -DestinationPath "dist/PawnBit-windows.zip"

      # â”€â”€ 7. Rename artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Rename artifact
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
             mv "dist/PawnBit.exe" "dist/${{ matrix.artifact }}"
          else
             mv "dist/${{ matrix.dist_name }}" "dist/${{ matrix.artifact }}"
          fi

      # â”€â”€ 8. Upload build artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            dist/${{ matrix.artifact }}
            dist/PawnBit-windows.zip
          if-no-files-found: error

  # â”€â”€ Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ 1. Download all platform artifacts into one folder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      # â”€â”€ 2. Determine the tag / version string â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ 3. Publish pre-release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "PawnBit ${{ steps.version.outputs.tag }} (Beta)"
          prerelease: true
          draft: false
          body: |
            ## ðŸŽ® PawnBit ${{ steps.version.outputs.tag }} â€” Beta

            > âš ï¸ **This is a pre-release / beta build.** Expect rough edges.
            > Please report issues here: [GitHub Issues](../../issues)

            ---

            ### ðŸ“¥ Downloads

            | Platform | File | Notes |
            |----------|------|-------|
            | ðŸªŸ **Windows (EXE)** | `PawnBit-windows.exe` | Single file, might trigger AV |
            | ðŸ“¦ **Windows (ZIP)** | `PawnBit-windows.zip` | More stable, extract & run |
            | ðŸŽ **macOS** | `PawnBit-macos` | See instructions below |
            | ðŸ§ **Linux** | `PawnBit-linux` | See instructions below |

            ---

            ### ðŸš€ Getting started

            **Windows**
            1. Download `PawnBit-windows.exe`
            2. Run it â€” Stockfish is downloaded automatically on first launch

            **macOS / Linux**
            ```bash
            chmod +x PawnBit-macos   # or PawnBit-linux
            ./PawnBit-macos
            ```
            > macOS may prompt for Accessibility permissions (needed for pyautogui).

            **Source code**
            ```bash
            python -m venv venv
            # Windows:
            venv\Scripts\pip install -r requirements.txt
            venv\Scripts\python src\gui.py
            # macOS / Linux:
            venv/bin/pip3 install -r requirements.txt
            venv/bin/python3 src/gui.py
            ```

            ---

            ### âœ¨ What's new in v1.0.0-beta.3
            - **Ghost Human Mode**: Advanced mouseless injection that simulates realistic mouse movements and jitter (Enable "Human-like Random Delay").
            - **Settings Management**: Added Auto-Save and Config Import/Export buttons (Check the bottom right!).
            - **Performance Calibration**: Reduced CPU overhead for board detection and synchronized engine evaluation.
            - **Lichess Logic Overhaul**: Improved color detection and move synchronization for anonym/guest modes.
            - **Clean Console**: Removed redundant "Syncing" messages for a better terminal experience.

          files: |
            release-assets/PawnBit-windows.exe
            release-assets/PawnBit-windows.zip
            release-assets/PawnBit-macos
            release-assets/PawnBit-linux
