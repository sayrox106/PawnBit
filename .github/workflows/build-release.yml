name: Build & Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to use (e.g. v1.0.0-beta.3)"
        required: true
        default: "v1.0.0-beta.3"

permissions:
  contents: write

jobs:
  build:
    name: Build [${{ matrix.os }}]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact: PawnBit-windows.exe
            dist_name: PawnBit.exe

          - os: macos-latest
            artifact: PawnBit-macos
            dist_name: PawnBit

          - os: ubuntu-latest
            artifact: PawnBit-linux
            dist_name: PawnBit

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-tk python3-dev libxcb-xinerama0 libxkbcommon-x11-0 xvfb scrot

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyinstaller>=6.5
          pip install -r requirements.txt

      - name: Prepare bundled engine
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "src/assets/engines/default"
          # We bundle a generic version to ensure startup on all systems
          $url = "https://github.com/official-stockfish/Stockfish/releases/download/sf_18/stockfish-windows-x86-64-modern.zip"
          if ($IsLinux -or $IsMacOS) {
             # Add linux/macos logic if needed, but for now we focus on fixing Windows
          }
          Invoke-WebRequest -Uri $url -OutFile "sf.zip"
          Expand-Archive -Path "sf.zip" -DestinationPath "temp_sf"
          $bin = Get-ChildItem -Path "temp_sf" -Filter "stockfish*.exe" -Recurse | Select-Object -First 1
          Move-Item -Path $bin.FullName -Destination "src/assets/engines/default/stockfish.exe"
          '{"version":"18","build":"bundled","arch":"x86-64","binary_path":"assets/engines/default/stockfish.exe"}' | Out-File -FilePath "src/assets/engines/default/version.json" -Encoding utf8

      - name: Build with PyInstaller
        run: pyinstaller --clean PawnBit.spec

      - name: Create Portable ZIP (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist/PawnBit.exe" -DestinationPath "dist/PawnBit-windows.zip"

      - name: Rename & Upload
        shell: bash
        run: |
          mv dist/${{ matrix.dist_name }} dist/${{ matrix.artifact }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/*

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name || github.event.inputs.tag }}
          name: "PawnBit Release (v1.0.0-beta.3)"
          prerelease: true
          body: |
            ### ðŸš€ PawnBit v1.0.0-beta.3 â€” Fixed EXE Edition

            This release fixes the "instant crash" issue when running as a standalone EXE.

            **Changes:**
            - **Fixed Selenium Manager**: Bundled the necessary driver binaries correctly.
            - **Early Error Logging**: If it crashes, check `error_log.txt` in the same folder.
            - **Ghost Human Mode**: Updated human-like mouse simulation for mouseless play.
            - **Auto-Save**: Settings are now remembered across sessions.
          files: |
            release-assets/PawnBit-windows.exe
            release-assets/PawnBit-windows.zip
            release-assets/PawnBit-macos
            release-assets/PawnBit-linux
